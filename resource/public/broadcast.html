<!DOCTYPE html>
<html lang="zh">
    <head>
        <title>WebSocket å¹¿æ’­æµ‹è¯•</title>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
        <link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
        <style>
            body {
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            h2 {
                color: #333;
                margin-bottom: 20px;
            }
            #divShow {
                max-height: 500px;
                overflow-y: auto;
                margin-bottom: 20px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
                background-color: #fafafa;
            }
            .client-info {
                background-color: #e8f4f8;
                padding: 8px;
                margin-bottom: 10px;
                border-radius: 4px;
                font-size: 12px;
                color: #666;
            }
            .message-item {
                margin-bottom: 8px;
                padding: 8px;
                border-radius: 4px;
                word-wrap: break-word;
            }
            .timestamp {
                font-size: 11px;
                color: #999;
                margin-right: 10px;
            }
            .user-input {
                margin-top: 15px;
            }
            .status-badge {
                display: inline-block;
                padding: 4px 8px;
                border-radius: 3px;
                font-size: 12px;
                margin-left: 10px;
            }
            .status-connected {
                background-color: #5cb85c;
                color: white;
            }
            .status-disconnected {
                background-color: #d9534f;
                color: white;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>
                WebSocket å¹¿æ’­æµ‹è¯•
                <span id="statusBadge" class="status-badge status-disconnected">æœªè¿æ¥</span>
            </h2>
            <div class="client-info" id="clientInfo">
                å®¢æˆ·ç«¯ID: <span id="clientId"></span> | è¿æ¥çŠ¶æ€: <span id="connectionStatus">ç­‰å¾…è¿æ¥...</span>
            </div>
            <div class="list-group" id="divShow"></div>
            <div class="user-input">
                <div class="input-group">
                    <input type="text" class="form-control" id="txtContent" autofocus placeholder="è¾“å…¥è¦å¹¿æ’­çš„æ¶ˆæ¯...">
                    <span class="input-group-btn">
                        <button class="btn btn-primary" id="btnSend">å‘é€å¹¿æ’­</button>
                    </span>
                </div>
                <small class="text-muted" style="display: block; margin-top: 10px;">
                    æç¤ºï¼šæ‰“å¼€å¤šä¸ªæµè§ˆå™¨çª—å£æˆ–æ ‡ç­¾é¡µï¼Œåœ¨ä¸€ä¸ªçª—å£ä¸­å‘é€æ¶ˆæ¯ï¼Œæ‰€æœ‰çª—å£éƒ½ä¼šæ”¶åˆ°å¹¿æ’­æ¶ˆæ¯
                </small>
            </div>
        </div>
    </body>
</html>

<script type="application/javascript">
    // ç”Ÿæˆå®¢æˆ·ç«¯ID
    const clientId = 'Client-' + Math.random().toString(36).substr(2, 9);
    document.getElementById('clientId').textContent = clientId;

    function showInfo(content) {
        const timestamp = new Date().toLocaleTimeString();
        const html = '<div class="list-group-item list-group-item-info message-item">' +
            '<span class="timestamp">[' + timestamp + ']</span>' + content + '</div>';
        $(html).appendTo("#divShow");
        $("#divShow").scrollTop($("#divShow")[0].scrollHeight);
    }

    function showWarning(content) {
        const timestamp = new Date().toLocaleTimeString();
        const html = '<div class="list-group-item list-group-item-warning message-item">' +
            '<span class="timestamp">[' + timestamp + ']</span>' + content + '</div>';
        $(html).appendTo("#divShow");
        $("#divShow").scrollTop($("#divShow")[0].scrollHeight);
    }

    function showSuccess(content) {
        const timestamp = new Date().toLocaleTimeString();
        const html = '<div class="list-group-item list-group-item-success message-item">' +
            '<span class="timestamp">[' + timestamp + ']</span>' + content + '</div>';
        $(html).appendTo("#divShow");
        $("#divShow").scrollTop($("#divShow")[0].scrollHeight);
    }

    function showError(content) {
        const timestamp = new Date().toLocaleTimeString();
        const html = '<div class="list-group-item list-group-item-danger message-item">' +
            '<span class="timestamp">[' + timestamp + ']</span>' + content + '</div>';
        $(html).appendTo("#divShow");
        $("#divShow").scrollTop($("#divShow")[0].scrollHeight);
    }

    function updateStatus(connected) {
        const badge = $('#statusBadge');
        const status = $('#connectionStatus');
        if (connected) {
            badge.removeClass('status-disconnected').addClass('status-connected').text('å·²è¿æ¥');
            status.text('å·²è¿æ¥');
        } else {
            badge.removeClass('status-connected').addClass('status-disconnected').text('æœªè¿æ¥');
            status.text('æœªè¿æ¥');
        }
    }

    $(function () {
        // è·å–å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœº
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const url = protocol + "//" + host + "/ws";
        let ws = new WebSocket(url);

        try {
            // WebSocket è¿æ¥æˆåŠŸ
            ws.onopen = function () {
                updateStatus(true);
                showInfo("âœ… WebSocket æœåŠ¡å™¨ [" + url + "] è¿æ¥æˆåŠŸï¼å®¢æˆ·ç«¯ID: " + clientId);
            };

            // WebSocket è¿æ¥å…³é—­
            ws.onclose = function () {
                updateStatus(false);
                if (ws) {
                    ws.close();
                    ws = null;
                }
                showError("âŒ WebSocket æœåŠ¡å™¨ [" + url + "] è¿æ¥å·²å…³é—­ï¼");
            };

            // WebSocket è¿æ¥é”™è¯¯
            ws.onerror = function () {
                updateStatus(false);
                if (ws) {
                    ws.close();
                    ws = null;
                }
                showError("âŒ WebSocket æœåŠ¡å™¨ [" + url + "] è¿æ¥é”™è¯¯ï¼");
            };

            // WebSocket å“åº”æ¶ˆæ¯ï¼ˆæ¥æ”¶å¹¿æ’­ï¼‰
            ws.onmessage = function (event) {
                try {
                    // æœåŠ¡ç«¯ä½¿ç”¨ WriteJSON å‘é€ï¼Œæ‰€ä»¥æ¶ˆæ¯æ˜¯ JSON å­—ç¬¦ä¸²
                    let message = event.data;
                    // å¦‚æœæ˜¯ JSON å­—ç¬¦ä¸²ï¼Œå°è¯•è§£æ
                    if (typeof message === 'string' && message.startsWith('"')) {
                        message = JSON.parse(message);
                    }
                    showWarning("ğŸ“¢ æ”¶åˆ°å¹¿æ’­: " + message);
                } catch (e) {
                    showWarning("ğŸ“¢ æ”¶åˆ°å¹¿æ’­: " + event.data);
                }
            };
        } catch (e) {
            alert("è¿æ¥é”™è¯¯: " + e.message);
        }

        // ç‚¹å‡»å‘é€æ¶ˆæ¯
        $("#btnSend").on("click", function () {
            if (ws == null || ws.readyState !== WebSocket.OPEN) {
                showError("WebSocket æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼");
                return;
            }
            const content = $.trim($("#txtContent").val());
            if (content.length <= 0) {
                alert("è¯·è¾“å…¥è¦å‘é€çš„å†…å®¹ï¼");
                return;
            }
            
            // å‘é€ JSON æ ¼å¼çš„æ¶ˆæ¯ï¼ˆæœåŠ¡ç«¯ä½¿ç”¨ ReadJSON è¯»å–ï¼‰
            try {
                ws.send(JSON.stringify(content));
                $("#txtContent").val("");
                showSuccess("ğŸ“¤ å‘é€å¹¿æ’­: " + content);
            } catch (e) {
                showError("å‘é€å¤±è´¥: " + e.message);
            }
        });

        // å›è½¦å‘é€æ¶ˆæ¯
        $("#txtContent").on("keydown", function (event) {
            if (event.keyCode === 13) {
                $("#btnSend").trigger("click");
            }
        });
    })
</script>

